<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.7">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">Mutable queues | Gospel</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://ocaml-gospel.github.io/gospel/walkthroughs/mutable-queue"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Mutable queues | Gospel"><meta data-react-helmet="true" name="description" content="This example aims to provide a formal specification for a mutable queue data"><meta data-react-helmet="true" property="og:description" content="This example aims to provide a formal specification for a mutable queue data"><link data-react-helmet="true" rel="canonical" href="https://ocaml-gospel.github.io/gospel/walkthroughs/mutable-queue"><link data-react-helmet="true" rel="alternate" href="https://ocaml-gospel.github.io/gospel/walkthroughs/mutable-queue" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://ocaml-gospel.github.io/gospel/walkthroughs/mutable-queue" hreflang="x-default"><link rel="stylesheet" href="/gospel/assets/css/styles.668f29b1.css">
<link rel="preload" href="/gospel/assets/js/runtime~main.e807e826.js" as="script">
<link rel="preload" href="/gospel/assets/js/main.c6815175.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#ffba00" role="banner"><div class="announcementBarContent_3EUC"><strong>âš  This documentation is still work-in-progress; its contents is unstable.</strong></div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/gospel/"><b class="navbar__title">Gospel</b></a><a class="navbar__item navbar__link navbar__link--active" href="/gospel/">Docs</a><a class="navbar__item navbar__link" href="/gospel/stdlib">Standard Library</a><a class="navbar__item navbar__link" href="/gospel/faq">FAQ</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ocaml-gospel/gospel" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/gospel/">Welcome!</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Walk-throughs</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gospel/walkthroughs/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gospel/walkthroughs/fibonacci">Fibonacci numbers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/gospel/walkthroughs/mutable-queue">Mutable queues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gospel/walkthroughs/union-find">Union-find</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Language specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/gospel/good-practices">Tips and good practices</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Mutable queues</h1></header><p>This example aims to provide a formal specification for a mutable queue data
structure, similar to OCaml&#x27;s standard library <code>Queue</code>.</p><p>This work is adapted from the article <em>GOSPEL -Providing OCaml with a Formal
Specification Language</em><sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>, which also
features an implementation of the following specification that was formally
verified using Why3gospel.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="modeling-the-queue-datastructure">Modeling the queue datastructure<a aria-hidden="true" class="hash-link" href="#modeling-the-queue-datastructure" title="Direct link to heading">â€‹</a></h2><p>Let&#x27;s start by defining the type of queues: the <code>&#x27;a t</code> type represents a
polymorphic queue, storing elements of type <code>&#x27;a</code>. To enable reasoning about the
elements of a queue, we attach one model to its type declaration:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">type</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ mutable model view: &#x27;a seq *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The model <code>view</code> represents the mathematical sequence of elements stored in
the queue. The type <code>&#x27;a seq</code> is the type of logical sequences defined in the
Gospel standard library and is for specifications only. The <code>mutable</code>
keyword states that the <code>view</code> field can change over time.</p><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>This shows how Gospel annotations provide extra insight and are also relevant
for documentation: the <code>mutable</code> keyword states that the type <code>&#x27;a t</code> is mutable,
which cannot be deduced from its OCaml declaration alone.</p></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="pushing-into-the-queue">Pushing into the queue<a aria-hidden="true" class="hash-link" href="#pushing-into-the-queue" title="Direct link to heading">â€‹</a></h2><p>Let us now declare and specify a <code>push</code> operation for these queues:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> push</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ push v q</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies q</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures  q.view = Seq.cons v (old q.view) *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><ul><li>The first line of the specification is the header; it names the two arguments
of <code>push</code>: <code>v</code> and <code>q</code>.</li><li>The <code>modifies</code> clause states that the function <code>push</code> may mutate the contents
of <code>q</code>.</li><li>Finally, the <code>ensures</code> clause introduces a post-condition that describes the
model <code>view</code> of <code>q</code> after a call to <code>push</code>: the new <code>view</code> extends the old
value of <code>view</code> with the element <code>v</code> at the front. We use the keyword <code>old</code> to
refer to the value of an expression (here, <code>q.view</code>) in the pre-state, <em>i.e.</em>,
before the function call.</li></ul><p>Note that the module <code>Seq</code> is part of the Gospel standard library and should not
be confused with module <code>Seq</code> from the OCaml standard library.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="various-flavors-of-pop">Various flavors of <code>pop</code><a aria-hidden="true" class="hash-link" href="#various-flavors-of-pop" title="Direct link to heading">â€‹</a></h2><p>Let us now move to another function, <code>pop</code>, and illustrate three ways of
handling assumptions from the client in Gospel specifications.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="exceptional-version">Exceptional version<a aria-hidden="true" class="hash-link" href="#exceptional-version" title="Direct link to heading">â€‹</a></h3><p>In this version, similar to the one provided by the OCaml standard library,
<code>pop</code> raises an <code>Empty</code> exception if its argument is an empty queue. We specify
this behaviour as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">exception</span><span class="token plain"> </span><span class="token module variable" style="color:rgb(201, 103, 101)">Empty</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> pop</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ v = pop q</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies q</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures  old q.view = q.view ++ Seq.cons v empty</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    raises   Empty -&gt; q.view = old q.view = empty *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We have two post-conditions:</p><ul><li>The first one, introduced with <code>ensures</code>, states the post-condition that holds
whenever the function <code>pop</code> returns a value <code>v</code>.</li><li>The second one, introduced by <code>raises</code>, states the exceptional post-condition
that holds whenever the call raises the exception <code>Empty</code>.</li></ul><p>Similarly to the <code>push</code> case, the clause <code>modifies</code> indicates that this function
call may mutate <code>q</code>. Note that this applies to the exceptional case as well, and
that&#x27;s why we state that <code>q</code> is both empty and not modified.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="unsafe-version">Unsafe version<a aria-hidden="true" class="hash-link" href="#unsafe-version" title="Direct link to heading">â€‹</a></h3><p>Now, let us consider an unsafe variant of <code>pop</code> that should only be called on a
non-empty queue, leaving the responsibility of that property to the client code.
The function does not raise <code>Empty</code> anymore but instead expects a non-empty
argument. We can thus add the following pre-condition to the contract using the
keyword <code>requires</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> unsafe_pop</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ v = pop q</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    requires q.view &lt;&gt; empty</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies q</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures  old q.view = q.view ++ (Seq.cons v empty) *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h3 class="anchor anchorWithStickyNavbar_31ik" id="defensive-version">Defensive version<a aria-hidden="true" class="hash-link" href="#defensive-version" title="Direct link to heading">â€‹</a></h3><p>Instead of assuming that the precondition is guaranteed by the caller, we can
also adopt a more defensive approach where <code>pop</code> raises <code>Invalid_argument</code>
whenever an empty queue is provided. Gospel provides a way to declare such a
behavior, using <code>checks</code> instead of <code>requires</code>:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> pop</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ v = pop q</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">      checks   q.view &lt;&gt; empty</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">      modifies q</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">      ensures  old q.view = q.view ++ (Seq.cons v empty) *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>checks</code> keyword means that function itself checks the pre-condition
<code>q.view &lt;&gt; empty</code> and raises <code>Invalid_argument</code> whenever it does not hold. Note
that <code>q.view</code> is just a logical model and may not exist at all in the
implementation. However, the function checks a property that, from a logical
point of view, results in <code>q.view</code> not being empty.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="a-small-break-is_empty">A small break: <code>is_empty</code><a aria-hidden="true" class="hash-link" href="#a-small-break-is_empty" title="Direct link to heading">â€‹</a></h2><p>Our next function needs a simpler specification. Consider the following
declaration for an emptiness test, together with its contract:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> is_empty</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> bool</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ b = is_empty q</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">      ensures b &lt;-&gt; q.view = empty *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The post-conditions captures that the function returns <code>true</code> if and only if the
queue is empty.</p><p>Although very simple, note that the above specification implies an important
property: since no <code>modifies</code> clause is present, the argument <code>q</code> is read-only:
we know that a call to <code>is_empty</code> does not modify <code>q.view</code>.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="creating-queues">Creating queues<a aria-hidden="true" class="hash-link" href="#creating-queues" title="Direct link to heading">â€‹</a></h2><p>The next function features the creation of a queue. Its declaration and
specification are as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> create</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> unit </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ q = create ()</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">      ensures q.view = empty *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The newly created queue has no elements: its <code>view</code> model equals the <code>empty</code>
sequence, as stated by the post-condition.</p><p>It is worth mentioning that the specification implicitly assumes <code>q</code> to be
disjoint from every previously allocated queue. This is an important design
choice of Gospel that follows a rule of thumbs: writing functions that return
non-fresh, mutable values is considered bad practice in OCaml.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="merging-queues">Merging queues<a aria-hidden="true" class="hash-link" href="#merging-queues" title="Direct link to heading">â€‹</a></h2><p>Let us conclude this specification with a functions to merge two queues. Several
approaches are possible; we will showcase three of them.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="in-place-transfer">In-place transfer<a aria-hidden="true" class="hash-link" href="#in-place-transfer" title="Direct link to heading">â€‹</a></h3><p>Let us start with a concatenation that transfers all elements from one queue to
another, with the following specification:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> transfer</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ transfer src dst</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies src, dst</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures  src.view = empty</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures  dst.view = old dst.view ++ old src.view *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Here, the contract states that both queues are modified. The queue <code>src</code> is
emptied after the call and its elements are appended to the queue <code>dst</code>. Notice
the use of <code>old</code> in the second post-condition, which helps us refer to the state
of the queues before they are passed to the function.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="destructive-operations">Destructive operations<a aria-hidden="true" class="hash-link" href="#destructive-operations" title="Direct link to heading">â€‹</a></h3><p>One could think of a slightly different version of <code>transfer</code>,
<code>destructive_transfer</code>, that invalidates <code>src</code> when called. In other words, the
value of <code>src</code> should be considered dirty and must not be used anymore in the
rest of the program. Such use-cases are frequent in system programming, for
instance when dealing with file descriptors after <code>fclose</code> calls. Gospel
provides <code>consumes</code> clauses to capture this semantic:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> destructive_transfer</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ destructive_transfer src dst</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    consumes src</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies dst</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures  dst.view = old dst.view ++ old src.view *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Note that we do not need to give informations on <code>src</code> in the post-state, since
its value must not be used anymore.</p><h3 class="anchor anchorWithStickyNavbar_31ik" id="a-constructive-version">A constructive version<a aria-hidden="true" class="hash-link" href="#a-constructive-version" title="Direct link to heading">â€‹</a></h3><p>Finally, a perhaps simpler version may consist in a <code>concat</code> function creating a
fresh queue with the elements of the queues passed as arguments:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> concat</span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> t</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ new = concat q1 q2</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures new.view = q1.view ++ q2.view *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>In this version, no <code>modifies</code> appears, meaning that none of the arguments are
modified by the function, thus specifying their model in the post-state is not
necessary.</p><div class="footnotes"><hr><ol><li id="fn-1">Arthur CharguÃ©raud, Jean-Christophe FilliÃ¢tre, ClÃ¡udio LourenÃ§o, MÃ¡rio
Pereira. GOSPEL -Providing OCaml with a Formal Specification Language. FM
2019 - 23rd International Symposium on Formal Methods, Oct 2019, Porto,
Portugal. âŸ¨<a href="https://hal.inria.fr/hal-02157484" target="_blank" rel="noopener noreferrer">hal-02157484</a>âŸ©<a href="#fnref-1" class="footnote-backref">â†©</a></li></ol></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/gospel/walkthroughs/fibonacci"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Fibonacci numbers</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/gospel/walkthroughs/union-find"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Union-find<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#modeling-the-queue-datastructure" class="table-of-contents__link toc-highlight">Modeling the queue datastructure</a></li><li><a href="#pushing-into-the-queue" class="table-of-contents__link toc-highlight">Pushing into the queue</a></li><li><a href="#various-flavors-of-pop" class="table-of-contents__link toc-highlight">Various flavors of <code>pop</code></a><ul><li><a href="#exceptional-version" class="table-of-contents__link toc-highlight">Exceptional version</a></li><li><a href="#unsafe-version" class="table-of-contents__link toc-highlight">Unsafe version</a></li><li><a href="#defensive-version" class="table-of-contents__link toc-highlight">Defensive version</a></li></ul></li><li><a href="#a-small-break-is_empty" class="table-of-contents__link toc-highlight">A small break: <code>is_empty</code></a></li><li><a href="#creating-queues" class="table-of-contents__link toc-highlight">Creating queues</a></li><li><a href="#merging-queues" class="table-of-contents__link toc-highlight">Merging queues</a><ul><li><a href="#in-place-transfer" class="table-of-contents__link toc-highlight">In-place transfer</a></li><li><a href="#destructive-operations" class="table-of-contents__link toc-highlight">Destructive operations</a></li><li><a href="#a-constructive-version" class="table-of-contents__link toc-highlight">A constructive version</a></li></ul></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2020â€”2021 Gospel maintainers.</div></div></div></footer></div>
<script src="/gospel/assets/js/runtime~main.e807e826.js"></script>
<script src="/gospel/assets/js/main.c6815175.js"></script>
</body>
</html>