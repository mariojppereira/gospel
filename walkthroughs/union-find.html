<!doctype html>
<html class="docs-version-current" lang="en" dir="ltr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<meta name="generator" content="Docusaurus v2.0.0-beta.7">
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.13.11/dist/katex.min.css" integrity="sha384-Um5gpz1odJg5Z4HAmzPtgZKdTBHZdw8S29IecapCSB31ligYPhHQZMIlWLYQGVoc" crossorigin="anonymous"><title data-react-helmet="true">Union-find | Gospel</title><meta data-react-helmet="true" name="twitter:card" content="summary_large_image"><meta data-react-helmet="true" property="og:url" content="https://ocaml-gospel.github.io/gospel/walkthroughs/union-find"><meta data-react-helmet="true" name="docusaurus_locale" content="en"><meta data-react-helmet="true" name="docusaurus_version" content="current"><meta data-react-helmet="true" name="docusaurus_tag" content="docs-default-current"><meta data-react-helmet="true" property="og:title" content="Union-find | Gospel"><meta data-react-helmet="true" name="description" content="In this example, we will highlight an advanced use-case of ghost declarations in"><meta data-react-helmet="true" property="og:description" content="In this example, we will highlight an advanced use-case of ghost declarations in"><link data-react-helmet="true" rel="canonical" href="https://ocaml-gospel.github.io/gospel/walkthroughs/union-find"><link data-react-helmet="true" rel="alternate" href="https://ocaml-gospel.github.io/gospel/walkthroughs/union-find" hreflang="en"><link data-react-helmet="true" rel="alternate" href="https://ocaml-gospel.github.io/gospel/walkthroughs/union-find" hreflang="x-default"><link rel="stylesheet" href="/gospel/assets/css/styles.668f29b1.css">
<link rel="preload" href="/gospel/assets/js/runtime~main.cb44c358.js" as="script">
<link rel="preload" href="/gospel/assets/js/main.c6815175.js" as="script">
</head>
<body>
<script>!function(){function t(t){document.documentElement.setAttribute("data-theme",t)}var e=function(){var t=null;try{t=localStorage.getItem("theme")}catch(t){}return t}();null!==e?t(e):window.matchMedia("(prefers-color-scheme: dark)").matches?t("dark"):(window.matchMedia("(prefers-color-scheme: light)").matches,t("light"))}(),document.documentElement.setAttribute("data-announcement-bar-initially-dismissed",function(){try{return"true"===localStorage.getItem("docusaurus.announcement.dismiss")}catch(t){}return!1}())</script><div id="__docusaurus">
<div><a href="#" class="skipToContent_1oUP">Skip to main content</a></div><div class="announcementBar_3WsW" style="background-color:#ffba00" role="banner"><div class="announcementBarContent_3EUC"><strong>âš  This documentation is still work-in-progress; its contents is unstable.</strong></div></div><nav class="navbar navbar--fixed-top"><div class="navbar__inner"><div class="navbar__items"><button aria-label="Navigation bar toggle" class="navbar__toggle clean-btn" type="button" tabindex="0"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/gospel/"><b class="navbar__title">Gospel</b></a><a class="navbar__item navbar__link navbar__link--active" href="/gospel/">Docs</a><a class="navbar__item navbar__link" href="/gospel/stdlib">Standard Library</a><a class="navbar__item navbar__link" href="/gospel/faq">FAQ</a></div><div class="navbar__items navbar__items--right"><a href="https://github.com/ocaml-gospel/gospel" target="_blank" rel="noopener noreferrer" class="navbar__item navbar__link header-github-link" aria-label="GitHub repository"></a><div class="toggle_71bT toggle_3Zt9 toggleDisabled_3cF-"><div class="toggleTrack_32Fl" role="button" tabindex="-1"><div class="toggleTrackCheck_3lV7"><span class="toggleIcon_O4iE">ðŸŒœ</span></div><div class="toggleTrackX_S2yS"><span class="toggleIcon_O4iE">ðŸŒž</span></div><div class="toggleTrackThumb_xI_Z"></div></div><input type="checkbox" class="toggleScreenReader_28Tw" aria-label="Switch between dark and light mode"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div class="main-wrapper docs-wrapper docs-doc-page"><div class="docPage_31aa"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_35hR" type="button"></button><aside class="docSidebarContainer_3Kbt"><div class="sidebar_15mo"><nav class="menu thin-scrollbar menu_Bmed menuWithAnnouncementBar_2WvA"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/gospel/">Welcome!</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Getting Started</a></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><a class="menu__link menu__link--sublist menu__link--active" href="#">Walk-throughs</a><ul style="display:block;overflow:visible;height:auto" class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gospel/walkthroughs/introduction">Introduction</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gospel/walkthroughs/fibonacci">Fibonacci numbers</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/gospel/walkthroughs/mutable-queue">Mutable queues</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/gospel/walkthroughs/union-find">Union-find</a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><a class="menu__link menu__link--sublist" href="#">Language specification</a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-1 menu__list-item"><a class="menu__link" href="/gospel/good-practices">Tips and good practices</a></li></ul></nav></div></aside><main class="docMainContainer_3ufF"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_3FnS"><div class="docItemContainer_33ec"><article><div class="tocCollapsible_1PrD theme-doc-toc-mobile tocMobile_3Hoh"><button type="button" class="clean-btn tocCollapsibleButton_2O1e">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Union-find</h1></header><p>In this example, we will highlight an advanced use-case of ghost declarations in
Gospel through the specification of a union-find datastructure.</p><p><a href="https://en.wikipedia.org/wiki/Disjoint-set_data_structure" target="_blank" rel="noopener noreferrer">Union-find</a> is a
fairly simple datastructure used to keep track of a collection of elements
partitioned into disjoint sets. Its most simple interface is as follows:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">type</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(** The type for set elements. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> make </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(** [make x] is the singleton containing an element wrapping [x]. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> find </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(** [find e] is the representative of the subset containing [e]. *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> union </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(** [union x y] merges the subset containing [x] with the subset</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    containing [y]. *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="why-is-this-hard-to-specify">Why is this hard to specify?<a aria-hidden="true" class="hash-link" href="#why-is-this-hard-to-specify" title="Direct link to heading">â€‹</a></h2><p>Union-find structures store a partition of a set. Notice that a typical
interface for union-find does not materialise this greater set (let us call it
our <em>universe</em>). Instead, the programmer has access to individual elements of
the set, and may merge them or access a representative of the partition it is
in.</p><p>However, for the sake of specification, not having this global set is a problem.
How can we state that the subsets are disjoint? How do we refer to the set of
elements that exist in the union-find universe? Can we even tell that the
representative of an element (returned by <code>find</code>) is indeed part of a subset
that was <code>union</code>ed with it at some point? It seems that we cannot do any of this
by attaching contracts to our functions and type only.</p><p>This example shows how Gospel&#x27;s <em>ghost declarations</em> help describe such complex
behaviours.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="introducing-the-ghost-universe">Introducing the ghost universe<a aria-hidden="true" class="hash-link" href="#introducing-the-ghost-universe" title="Direct link to heading">â€‹</a></h2><p>Seemingly, the root of our problems is that union-find relies on the implicit
universe of elements. It does not exist in the OCaml&#x27;s interface, so let us
introduce it as a ghost type declaration. We can also add that this universe is
mutable: so long as elements are added, for instance, it will be modified.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ type &#x27;a universe *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ ephemeral *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Now, our three functions still apply to set elements, but they also apply <em>in the
context of an universe</em>: you create a new singleton subset in the context of the
greater set, or find the representative of an element in the rest of universe
for instance. This translates into our three functions taking a value of type <code>&#x27;a
universe</code> as argument. Of course, <code>&#x27;a universe</code> is ghost, and you do not want to
modify the signature of the functions anyway, so this argument is ghost too<sup id="fnref-1"><a href="#fn-1" class="footnote-ref">1</a></sup>.
We can also already get a sense that <code>make</code> and <code>union</code> will modify the
universe.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> make </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ e = make [u: &#x27;a universe] v</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies u *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> find </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ e = find [u: &#x27;a universe] x *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> union </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ union [u: &#x27;a universe] x y</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies u *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Since we now have a type for universes, and functions that take values of such
type, we probably need a constructor for this type. Let us introduce that as a
ghost value:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ val make_universe: unit -&gt; &#x27;a universe *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Having this abstract type on is not very useful so far. We are able to state
that the functions apply in the context of a universe, and that they may mutate
it, but that&#x27;s pretty much it. Let us be more precise than that.</p><h2 class="anchor anchorWithStickyNavbar_31ik" id="elements-gotta-catch-em-all">Elements: gotta catch &#x27;em all<a aria-hidden="true" class="hash-link" href="#elements-gotta-catch-em-all" title="Direct link to heading">â€‹</a></h2><p>A first interesting property that we would like to capture is that the subsets
are indeed disjoint. For instance, <code>make</code> should not create an element that is
already in the universe, otherwise you would have two different subsets
containing the same element.</p><p>In order to specify this, we need to be able to talk about the set of existing
elements in the universe. Let us introduce this as a logical model attached to
our <code>universe</code> type:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ type &#x27;a universe *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ mutable model dom : &#x27;a element set *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-tip alert alert--success"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="12" height="16" viewBox="0 0 12 16"><path fill-rule="evenodd" d="M6.5 0C3.48 0 1 2.19 1 5c0 .92.55 2.25 1 3 1.34 2.25 1.78 2.78 2 4v1h5v-1c.22-1.22.66-1.75 2-4 .45-.75 1-2.08 1-3 0-2.81-2.48-5-5.5-5zm3.64 7.48c-.25.44-.47.8-.67 1.11-.86 1.41-1.25 2.06-1.45 3.23-.02.05-.02.11-.02.17H5c0-.06 0-.13-.02-.17-.2-1.17-.59-1.83-1.45-3.23-.2-.31-.42-.67-.67-1.11C2.44 6.78 2 5.65 2 5c0-2.2 2.02-4 4.5-4 1.22 0 2.36.42 3.22 1.19C10.55 2.94 11 3.94 11 5c0 .66-.44 1.78-.86 2.48zM4 14h5c-.23 1.14-1.3 2-2.5 2s-2.27-.86-2.5-2z"></path></svg></span>tip</h5></div><div class="admonition-content"><p>Since at least one model is mutable, we may now omit the <code>ephemeral</code> keyword,
although it is valid to keep it if you prefer. For instance, you may keep it if
you want to indicate that the type is also mutable in a way that is not visible
in the models.</p></div></div><p>Now let us add more information on how the functions interact with it. The
constructor should ensure two things:</p><ul><li>The returned element is a fresh element.</li><li>The universe&#x27;s domain is augmented with the singleton containing the
provided value.</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> make </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ e = make [u: &#x27;a universe] v</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies u.dom</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures not (Set.mem e (old u.dom))</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures u.dom = Set.add e (old u.dom) *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>The <code>find</code> function obviously needs an element of the universe, and also returns
an element that is part of the universe:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> find </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ e = find [u: &#x27;a universe] x</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    requires Set.mem x u.dom</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures Set.mem e u.dom *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Finally, <code>union</code> requires that the provided elements are part of the universe
too. Note that it does not modify the universe domain (no element is added nor
removed), but since we added the <code>modify u</code> clause, we need to state that
explicitly, or the contract may imply that <code>u.dom</code> was modified (in an
unspecified way).</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> union </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ union [u: &#x27;a universe] x y</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    requires Set.mem x u.dom</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    requires Set.mem y u.dom</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies u</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures u.dom = old u.dom *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><h2 class="anchor anchorWithStickyNavbar_31ik" id="find-your-representative">Find your representative<a aria-hidden="true" class="hash-link" href="#find-your-representative" title="Direct link to heading">â€‹</a></h2><p>We can now talk about all the elements in our partition, but we still haven&#x27;t
mentioned elements representatives at all. Each element in the universe has a
representative in the set, so we may represent this using a <code>&#x27;a element -&gt; &#x27;a
element</code> function. We can also add two invariants:</p><ul><li>the representative of an element must live in the same universe as the
element itself.</li><li>the <code>rep</code> function is idempotent: the representative of an element is its own
representative.</li></ul><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ type &#x27;a universe *)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ mutable model dom : &#x27;a element set</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    mutable model rep : &#x27;a element -&gt; &#x27;a element</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    invariant forall e. Set.mem e dom -&gt; Set.mem (rep e) dom</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    invariant forall e. Set.mem e dom -&gt; rep (rep e) = rep e *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-caution alert alert--warning"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8.893 1.5c-.183-.31-.52-.5-.887-.5s-.703.19-.886.5L.138 13.499a.98.98 0 0 0 0 1.001c.193.31.53.501.886.501h13.964c.367 0 .704-.19.877-.5a1.03 1.03 0 0 0 .01-1.002L8.893 1.5zm.133 11.497H6.987v-2.003h2.039v2.003zm0-3.004H6.987V5.987h2.039v4.006z"></path></svg></span>caution</h5></div><div class="admonition-content"><p>Notice how in both cases, speaking of the representative of an element only
makes sense for elements that are in the universe. However, Gospel&#x27;s logic is
total, so <code>rep</code> is also defined outside of the universe, but it is unspecified
there.</p></div></div><p>Let us now add clauses to our functions to indicate how they interact with
<code>rep</code>. After a call to our constructor, the created element is obviously its own
representative, and all other representatives are left unchanged:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> make </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ e = make [u: &#x27;a universe] v</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies u.dom</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures not (Set.mem e (old u.dom))</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures u.dom = Set.add e (old u.dom)</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures u.rep = (old u.rep)[e &lt;- e] *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><div class="admonition admonition-note alert alert--secondary"><div class="admonition-heading"><h5><span class="admonition-icon"><svg xmlns="http://www.w3.org/2000/svg" width="14" height="16" viewBox="0 0 14 16"><path fill-rule="evenodd" d="M6.3 5.69a.942.942 0 0 1-.28-.7c0-.28.09-.52.28-.7.19-.18.42-.28.7-.28.28 0 .52.09.7.28.18.19.28.42.28.7 0 .28-.09.52-.28.7a1 1 0 0 1-.7.3c-.28 0-.52-.11-.7-.3zM8 7.99c-.02-.25-.11-.48-.31-.69-.2-.19-.42-.3-.69-.31H6c-.27.02-.48.13-.69.31-.2.2-.3.44-.31.69h1v3c.02.27.11.5.31.69.2.2.42.31.69.31h1c.27 0 .48-.11.69-.31.2-.19.3-.42.31-.69H8V7.98v.01zM7 2.3c-3.14 0-5.7 2.54-5.7 5.68 0 3.14 2.56 5.7 5.7 5.7s5.7-2.55 5.7-5.7c0-3.15-2.56-5.69-5.7-5.69v.01zM7 .98c3.86 0 7 3.14 7 7s-3.14 7-7 7-7-3.12-7-7 3.14-7 7-7z"></path></svg></span>note</h5></div><div class="admonition-content"><p>The <code>_[_ &lt;- _]</code> operator is defined in the <a href="/gospel/stdlib">standard library</a>. The
notation <code>f[x &lt;- y]</code> is a shorthand notation for the function defined as <code>fun i
-&gt; if i = x then y else f i</code></p></div></div><p>The <code>find</code> function does not modify the representatives, but return the
representative of the input element:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> find </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ e = find [u: &#x27;a universe] x</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    requires Set.mem x u.dom</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures Set.mem e u.dom</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures e = u.rep x *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>Finally, the postcondition for <code>union</code> is a bit more involved. We need to
capture that the new representative of an element may change.</p><p>First, it is left unchanged if the element is not in <code>x</code> nor <code>y</code> subset.</p><p>Let&#x27;s start by introducing a predicate that will help us decide if two elements
are in the same subset (or equivalence class). This is the case iff they have
the same subset representative:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ predicate equivalent (u: &#x27;a universe) (x y: &#x27;a element) =</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">      u.rep x = u.rep y *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We can now use that to state that elements that are not equivalent to <code>x</code> or <code>y</code>
have the same representative:</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> union </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> elements </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> elements </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ union [u: &#x27;a universe] x y</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    requires Set.mem x u.dom</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    requires Set.mem y u.dom</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies u</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures u.dom = old u.dom</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures forall e.</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">      not (old (equivalent u x e \/ equivalent u y e))</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">      -&gt; u.rep e = old (u.rep e) *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>And finally, elements that were in the unioned subsets now must all have the
same representative, and that element is either the old <code>x</code> representative, or
the old <code>y</code> representative.</p><div class="codeBlockContainer_K1bP"><div class="codeBlockContent_hGly ocaml"><pre tabindex="0" class="prism-code language-ocaml codeBlock_23N8 thin-scrollbar" style="color:#403f53;background-color:#FBFBFB"><code class="codeBlockLines_39YC"><span class="token-line" style="color:#403f53"><span class="token keyword" style="color:rgb(12, 150, 155)">val</span><span class="token plain"> union </span><span class="token punctuation" style="color:rgb(153, 76, 195)">:</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> </span><span class="token type-variable function" style="color:rgb(153, 76, 195);font-style:italic">&#x27;a</span><span class="token plain"> element </span><span class="token operator" style="color:rgb(12, 150, 155)">-&gt;</span><span class="token plain"> unit</span><br></span><span class="token-line" style="color:#403f53"><span class="token plain"></span><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">(*@ union [u: &#x27;a universe] x y</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    requires Set.mem x u.dom</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    requires Set.mem y u.dom</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    modifies u</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures u.dom = old u.dom</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures forall e. not (old (equivalent u x e \/ equivalent u y e))</span><br></span><span class="token-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">                      -&gt; u.rep e = old (u.rep e)</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">    ensures exists r. (r = old (u.rep x) \/ r = old (u.rep y))</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">      /\ forall e. old (equivalent u x e \/ equivalent u y e)</span><br></span><span class="token-line docusaurus-highlight-code-line" style="color:#403f53"><span class="token comment" style="color:rgb(152, 159, 177);font-style:italic">                   -&gt; u.rep e = r *)</span><br></span></code></pre><button type="button" aria-label="Copy code to clipboard" class="copyButton_Ue-o clean-btn">Copy</button></div></div><p>We could go further and add more functions, for instance an equality function
over <code>element</code>s, or a <code>get</code> function to extract the value contained in an
element, but we&#x27;ll keep it there for this tutorial. Hopefully, you now have a
better overview of the purpose of ghost types in Gospel specifications and how
they can help you refer to meta-elements that are not present in the code, or
not exposed.</p><div class="footnotes"><hr><ol><li id="fn-1">If you&#x27;re not comfortable with ghost arguments, you may want to <a href="/gospel/walkthroughs/fibonacci">read our
Fibonacci walk-through</a> first.<a href="#fnref-1" class="footnote-backref">â†©</a></li></ol></div></div></article><nav class="pagination-nav docusaurus-mt-lg" aria-label="Docs pages navigation"><div class="pagination-nav__item"><a class="pagination-nav__link" href="/gospel/walkthroughs/mutable-queue"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Â« <!-- -->Mutable queues</div></a></div><div class="pagination-nav__item pagination-nav__item--next"><a class="pagination-nav__link" href="/gospel/language/locations"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Specification locations<!-- --> Â»</div></a></div></nav></div></div><div class="col col--3"><div class="tableOfContents_35-E thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#why-is-this-hard-to-specify" class="table-of-contents__link toc-highlight">Why is this hard to specify?</a></li><li><a href="#introducing-the-ghost-universe" class="table-of-contents__link toc-highlight">Introducing the ghost universe</a></li><li><a href="#elements-gotta-catch-em-all" class="table-of-contents__link toc-highlight">Elements: gotta catch &#39;em all</a></li><li><a href="#find-your-representative" class="table-of-contents__link toc-highlight">Find your representative</a></li></ul></div></div></div></div></main></div></div><footer class="footer footer--dark"><div class="container"><div class="footer__bottom text--center"><div class="footer__copyright">Copyright Â© 2020â€”2021 Gospel maintainers.</div></div></div></footer></div>
<script src="/gospel/assets/js/runtime~main.cb44c358.js"></script>
<script src="/gospel/assets/js/main.c6815175.js"></script>
</body>
</html>